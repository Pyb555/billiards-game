<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>台球练习 - iOS风格台球游戏</title>
  
  <!-- 外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/matter-js@0.20.0/build/matter.min.js"></script>
  
  <style>
    /* 自定义样式 */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
    }
    
    .screen {
      display: none;
      min-height: 100vh;
    }
    
    .screen.active {
      display: block;
    }
    
    .pool-table {
      position: relative;
      background-color: #0F3E0F;
      border-radius: 8px;
      overflow: hidden;
      width: 100%;
      aspect-ratio: 2/1;
      margin: 0 auto;
      box-shadow: inset 0 0 30px rgba(0,0,0,0.3);
    }
    
    .pool-ball {
      position: absolute;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      box-shadow: 
        inset -4px -4px 8px rgba(0,0,0,0.4), 
        inset 4px 4px 8px rgba(255,255,255,0.2),
        0 2px 4px rgba(0,0,0,0.3);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.7), rgba(255,255,255,0));
      transition: transform 0.05s linear;
    }
    
    .pool-cue {
      position: absolute;
      height: 4px;
      background: linear-gradient(90deg, #A0522D, #D2B48C, #A0522D);
      transform-origin: left center;
      z-index: 5;
      display: none;
      border-radius: 2px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    .pool-cue-tip {
      position: absolute;
      right: -6px;
      top: -3px;
      width: 6px;
      height: 10px;
      background-color: #F0F0F0;
      border-radius: 2px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(4px);
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background-color: white;
      border-radius: 20px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    
    .progress-bar {
      width: 200px;
      height: 4px;
      background-color: #E5E5EA;
      border-radius: 2px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background-color: #007AFF;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .pocket {
      position: absolute;
      width: 30px;
      height: 30px;
      background-color: #000;
      border-radius: 50%;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
      z-index: 4;
    }
  </style>
</head>
<body class="bg-[#F2F2F7] text-[#1C1C1E]">
  <!-- 加载屏幕 -->
  <div id="loading-screen" class="screen active flex flex-col items-center justify-center">
    <div class="text-center mb-6">
      <div class="w-20 h-20 bg-[#007AFF] rounded-2xl flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-billiard-ball text-4xl text-white"></i>
      </div>
      <h1 class="text-2xl font-bold mb-2">台球练习</h1>
      <p class="text-[#8E8E93]">iOS风格台球游戏</p>
    </div>
    
    <div class="progress-bar">
      <div id="loading-progress" class="progress-fill"></div>
    </div>
  </div>

  <!-- 主菜单屏幕 -->
  <div id="main-menu" class="screen">
    <div class="max-w-xs mx-auto p-5">
      <div class="text-center my-10">
        <div class="w-24 h-24 bg-[#007AFF] rounded-3xl flex items-center justify-center mx-auto mb-5">
          <i class="fas fa-billiard-ball text-5xl text-white"></i>
        </div>
        <h1 class="text-3xl font-bold mb-2">台球练习</h1>
        <p class="text-[#8E8E93]">享受真实的台球体验</p>
      </div>
      
      <button class="w-full bg-[#007AFF] text-white border-none rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="showScreen('game-mode-select')">
        <i class="fas fa-play-circle mr-2"></i> 开始游戏
      </button>
      
      <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="showScreen('multiplayer-screen')">
        <i class="fas fa-users mr-2"></i> 好友对战
      </button>
      
      <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="showScreen('settings-screen')">
        <i class="fas fa-cog mr-2"></i> 设置
      </button>
      
      <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium flex items-center justify-center" onclick="showScreen('about-screen')">
        <i class="fas fa-info-circle mr-2"></i> 关于
      </button>
    </div>
  </div>

  <!-- 游戏模式选择屏幕 -->
  <div id="game-mode-select" class="screen">
    <div class="max-w-xs mx-auto p-5">
      <div class="flex items-center mb-6">
        <button class="bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-2 px-3 mr-3" onclick="showScreen('main-menu')">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="text-xl font-bold">选择游戏模式</h2>
      </div>
      
      <div class="bg-white rounded-2xl p-4 mb-4 shadow-md cursor-pointer" onclick="selectMode('eight-ball')">
        <div class="flex items-center mb-3">
          <div class="w-10 h-10 bg-[#0F3E0F] rounded-full flex items-center justify-center mr-3">
            <span class="text-white font-bold">8</span>
          </div>
          <div>
            <h3 class="text-lg font-bold">中式八球</h3>
            <p class="text-[#8E8E93] text-sm">最受欢迎的台球玩法</p>
          </div>
        </div>
        <p class="text-sm text-gray-600">中式八球是一种融合了美式八球和英式斯诺克特点的台球运动，使用15颗目标球和1颗母球。</p>
      </div>
      
      <div class="bg-white rounded-2xl p-4 mb-4 shadow-md cursor-pointer" onclick="selectMode('snooker')">
        <div class="flex items-center mb-3">
          <div class="w-10 h-10 bg-[#0F3E0F] rounded-full flex items-center justify-center mr-3">
            <span class="text-white font-bold">S</span>
          </div>
          <div>
            <h3 class="text-lg font-bold">斯诺克</h3>
            <p class="text-[#8E8E93] text-sm">考验精准度的经典玩法</p>
          </div>
        </div>
        <p class="text-sm text-gray-600">斯诺克是一种需要高度技巧和策略的台球运动，使用22颗球，包括15颗红球、6颗彩球和1颗白球。</p>
      </div>
      
      <div class="bg-white rounded-2xl p-4 shadow-md cursor-pointer" onclick="selectMode('nine-ball')">
        <div class="flex items-center mb-3">
          <div class="w-10 h-10 bg-[#0F3E0F] rounded-full flex items-center justify-center mr-3">
            <span class="text-white font-bold">9</span>
          </div>
          <div>
            <h3 class="text-lg font-bold">中式九球</h3>
            <p class="text-[#8E8E93] text-sm">快速刺激的台球玩法</p>
          </div>
        </div>
        <p class="text-sm text-gray-600">中式九球是一种快节奏的台球运动，使用9颗编号球和1颗母球，选手必须按照球的编号顺序击打。</p>
      </div>
    </div>
  </div>

  <!-- 难度选择屏幕 -->
  <div id="difficulty-select" class="screen">
    <div class="max-w-xs mx-auto p-5">
      <div class="flex items-center mb-6">
        <button class="bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-2 px-3 mr-3" onclick="showScreen('game-mode-select')">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="text-xl font-bold">选择难度</h2>
      </div>
      
      <div class="mt-10">
        <button class="w-full bg-[#007AFF] text-white border-none rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="startGame('easy')">
          <i class="fas fa-smile mr-2"></i> 简单
        </button>
        
        <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="startGame('medium')">
          <i class="fas fa-meh mr-2"></i> 中等
        </button>
        
        <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium flex items-center justify-center" onclick="startGame('hard')">
          <i class="fas fa-frown mr-2"></i> 困难
        </button>
      </div>
    </div>
  </div>

  <!-- 游戏屏幕 -->
  <div id="game-screen" class="screen">
    <div class="bg-[#1C1C1E] text-white p-4">
      <div class="flex items-center justify-between">
        <button class="bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-2 px-3" onclick="pauseGame()">
          <i class="fas fa-pause"></i>
        </button>
        
        <div class="text-center">
          <div class="flex justify-between mb-1">
            <span>玩家: <span id="player-score">0</span></span>
            <span>电脑: <span id="computer-score">0</span></span>
          </div>
          <div class="bg-[#007AFF] py-1 px-4 rounded-xl inline-block text-sm" id="turn-indicator">你的回合</div>
        </div>
        
        <button class="bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-2 px-3" onclick="showSettings()">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>
    
    <div class="p-5">
      <div class="pool-table" id="pool-table">
        <!-- 球袋 -->
        <div class="pocket" style="top: -15px; left: -15px;"></div>
        <div class="pocket" style="top: -15px; right: -15px;"></div>
        <div class="pocket" style="bottom: -15px; left: -15px;"></div>
        <div class="pocket" style="bottom: -15px; right: -15px;"></div>
        <div class="pocket" style="top: -15px; left: 50%; transform: translateX(-50%);"></div>
        <div class="pocket" style="bottom: -15px; left: 50%; transform: translateX(-50%);"></div>
        
        <!-- 球杆 -->
        <div class="pool-cue" id="pool-cue">
          <div class="pool-cue-tip"></div>
        </div>
        
        <!-- 预测线 -->
        <div class="pool-cue" style="background: rgba(255,255,255,0.5); height: 2px;" id="prediction-line"></div>
      </div>
      
      <div class="mt-5">
        <div class="flex justify-between mb-2">
          <span class="text-[#8E8E93]">击球力度</span>
          <span id="power-value">0%</span>
        </div>
        <div class="h-1.5 bg-[#C7C7CC] rounded-full overflow-hidden">
          <div id="power-bar" class="h-full bg-[#FF3B30] w-0 transition-all duration-100"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 好友对战屏幕 -->
  <div id="multiplayer-screen" class="screen">
    <div class="max-w-xs mx-auto p-5">
      <div class="flex items-center mb-6">
        <button class="bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-2 px-3 mr-3" onclick="showScreen('main-menu')">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="text-xl font-bold">好友对战</h2>
      </div>
      
      <div class="bg-white rounded-2xl p-4 mb-4 shadow-md">
        <h3 class="text-lg font-bold mb-3">选择游戏模式</h3>
        <div class="flex gap-2">
          <button class="flex-1 bg-[#007AFF] text-white border-none rounded-xl py-2 text-sm">中式八球</button>
          <button class="flex-1 bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-2 text-sm">斯诺克</button>
          <button class="flex-1 bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-2 text-sm">中式九球</button>
        </div>
      </div>
      
      <div class="bg-white rounded-2xl p-4 shadow-md">
        <h3 class="text-lg font-bold mb-3">微信好友</h3>
        <div class="flex items-center p-3 rounded-xl bg-[#F2F2F7] mb-2">
          <div class="w-10 h-10 bg-[#07C160] rounded-full flex items-center justify-center mr-3 text-white font-bold">张</div>
          <div class="flex-1">
            <div class="font-medium">张三</div>
            <div class="text-xs text-[#8E8E93]">在线</div>
          </div>
          <button class="bg-[#007AFF] text-white rounded-xl py-1 px-3 text-sm">邀请</button>
        </div>
        
        <div class="flex items-center p-3 rounded-xl bg-[#F2F2F7]">
          <div class="w-10 h-10 bg-[#07C160] rounded-full flex items-center justify-center mr-3 text-white font-bold">李</div>
          <div class="flex-1">
            <div class="font-medium">李四</div>
            <div class="text-xs text-[#8E8E93]">在线</div>
          </div>
          <button class="bg-[#007AFF] text-white rounded-xl py-1 px-3 text-sm">邀请</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 设置屏幕 -->
  <div id="settings-screen" class="screen">
    <div class="max-w-xs mx-auto p-5">
      <div class="flex items-center mb-6">
        <button class="bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-2 px-3 mr-3" onclick="showScreen('main-menu')">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="text-xl font-bold">设置</h2>
      </div>
      
      <div class="bg-white rounded-2xl p-4 mb-4 shadow-md">
        <h3 class="text-lg font-bold mb-4">游戏设置</h3>
        
        <div class="flex justify-between items-center mb-4">
          <div>
            <div class="font-medium">音效</div>
            <div class="text-sm text-[#8E8E93]">游戏音效和背景音乐</div>
          </div>
          <label class="relative inline-block w-12 h-6">
            <input type="checkbox" checked class="opacity-0 w-0 h-0" id="sound-toggle">
            <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-[#C7C7CC] transition-all duration-300 rounded-full"></span>
            <span class="absolute content-[''] h-5 w-5 left-0.5 bottom-0.5 bg-white transition-all duration-300 rounded-full transform translate-x-6"></span>
          </label>
        </div>
        
        <div class="flex justify-between items-center mb-4">
          <div>
            <div class="font-medium">球路预测</div>
            <div class="text-sm text-[#8E8E93]">显示击球后的球路预测</div>
          </div>
          <label class="relative inline-block w-12 h-6">
            <input type="checkbox" checked class="opacity-0 w-0 h-0" id="prediction-toggle">
            <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-[#C7C7CC] transition-all duration-300 rounded-full"></span>
            <span class="absolute content-[''] h-5 w-5 left-0.5 bottom-0.5 bg-white transition-all duration-300 rounded-full transform translate-x-6"></span>
          </label>
        </div>
        
        <div class="flex justify-between items-center">
          <div>
            <div class="font-medium">振动反馈</div>
            <div class="text-sm text-[#8E8E93]">击球时的振动反馈</div>
          </div>
          <label class="relative inline-block w-12 h-6">
            <input type="checkbox" checked class="opacity-0 w-0 h-0" id="vibration-toggle">
            <span class="absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-[#C7C7CC] transition-all duration-300 rounded-full"></span>
            <span class="absolute content-[''] h-5 w-5 left-0.5 bottom-0.5 bg-white transition-all duration-300 rounded-full transform translate-x-6"></span>
          </label>
        </div>
      </div>
      
      <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium flex items-center justify-center" onclick="resetSettings()">
        <i class="fas fa-refresh mr-2"></i> 恢复默认设置
      </button>
    </div>
  </div>

  <!-- 关于屏幕 -->
  <div id="about-screen" class="screen">
    <div class="max-w-xs mx-auto p-5">
      <div class="flex items-center mb-6">
        <button class="bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-2 px-3 mr-3" onclick="showScreen('main-menu')">
          <i class="fas fa-arrow-left"></i>
        </button>
        <h2 class="text-xl font-bold">关于</h2>
      </div>
      
      <div class="bg-white rounded-2xl p-4 text-center shadow-md">
        <div class="w-20 h-20 bg-[#007AFF] rounded-2xl flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-billiard-ball text-4xl text-white"></i>
        </div>
        <h3 class="text-2xl font-bold mb-1">台球练习</h3>
        <p class="text-[#8E8E93] mb-4">版本 1.0.0</p>
        <p class="text-sm text-gray-600">一款iOS风格的台球游戏，提供中式八球、斯诺克和中式九球三种游戏模式，带来真实的台球体验。</p>
      </div>
    </div>
  </div>

  <!-- 暂停菜单 -->
  <div class="modal-overlay" id="pause-modal">
    <div class="modal">
      <h3 class="text-xl font-bold text-center mb-6">游戏暂停</h3>
      
      <button class="w-full bg-[#007AFF] text-white border-none rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="resumeGame()">
        <i class="fas fa-play mr-2"></i> 继续游戏
      </button>
      
      <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="restartGame()">
        <i class="fas fa-refresh mr-2"></i> 重新开始
      </button>
      
      <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="showScreen('settings-screen')">
        <i class="fas fa-cog mr-2"></i> 设置
      </button>
      
      <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium flex items-center justify-center" onclick="showScreen('main-menu')">
        <i class="fas fa-home mr-2"></i> 返回主菜单
      </button>
    </div>
  </div>

  <!-- 游戏结束菜单 -->
  <div class="modal-overlay" id="game-over-modal">
    <div class="modal">
      <h3 class="text-xl font-bold text-center mb-2" id="game-over-title">游戏结束</h3>
      <p class="text-center text-[#8E8E93] mb-6" id="game-over-message">你赢了！</p>
      
      <div class="flex justify-around mb-6">
        <div class="text-center">
          <div class="text-sm text-[#8E8E93]">你的得分</div>
          <div class="text-3xl font-bold text-[#007AFF]" id="final-player-score">8</div>
        </div>
        
        <div class="text-center">
          <div class="text-sm text-[#8E8E93]">电脑得分</div>
          <div class="text-3xl font-bold text-[#5856D6]" id="final-computer-score">5</div>
        </div>
      </div>
      
      <button class="w-full bg-[#007AFF] text-white border-none rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="restartGame()">
        <i class="fas fa-refresh mr-2"></i> 再玩一次
      </button>
      
      <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium mb-3 flex items-center justify-center" onclick="showScreen('game-mode-select')">
        <i class="fas fa-list mr-2"></i> 更换模式
      </button>
      
      <button class="w-full bg-[#F2F2F7] text-[#1C1C1E] border border-[#C7C7CC] rounded-xl py-3 px-6 text-lg font-medium flex items-center justify-center" onclick="showScreen('main-menu')">
        <i class="fas fa-home mr-2"></i> 返回主菜单
      </button>
    </div>
  </div>

  <script>
    // 全局游戏状态
    let gameState = {
      currentScreen: 'loading',
      selectedMode: 'eight-ball',
      difficulty: 'medium',
      isPaused: false,
      playerScore: 0,
      computerScore: 0,
      currentTurn: 'player',
      engine: null,
      world: null,
      balls: [],
      cueBall: null,
      isDragging: false,
      power: 0,
      nextBall: 1,
      computerNextBall: 1
    };

    // DOM加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      simulateLoading();
      initGameEvents();
      initSettingsToggles();
    });

    // 模拟加载过程
    function simulateLoading() {
      let progress = 0;
      const progressBar = document.getElementById('loading-progress');
      
      const interval = setInterval(function() {
        progress += Math.random() * 10;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          setTimeout(() => showScreen('main-menu'), 500);
        }
        progressBar.style.width = progress + '%';
      }, 200);
    }

    // 显示指定屏幕
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
      gameState.currentScreen = screenId;
    }

    // 选择游戏模式
    function selectMode(mode) {
      gameState.selectedMode = mode;
      showScreen('difficulty-select');
    }

    // 开始游戏
    function startGame(difficulty) {
      gameState = {
        ...gameState,
        difficulty,
        playerScore: 0,
        computerScore: 0,
        currentTurn: 'player',
        nextBall: 1,
        computerNextBall: 1
      };
      
      document.getElementById('player-score').textContent = '0';
      document.getElementById('computer-score').textContent = '0';
      document.getElementById('turn-indicator').textContent = '你的回合';
      
      showScreen('game-screen');
      initPhysicsEngine();
    }

    // 初始化物理引擎
    function initPhysicsEngine() {
      // 清理之前的引擎
      if (gameState.engine) {
        Matter.Engine.clear(gameState.engine);
        Matter.World.clear(gameState.world);
      }
      
      gameState.engine = Matter.Engine.create({
        enableSleeping: true,
        gravity: { y: 0 }
      });
      
      gameState.world = gameState.engine.world;
      createTableBoundaries();
      createBalls();
      Matter.Engine.run(gameState.engine);
      bindTableEvents();
    }

    // 创建台球桌边界
    function createTableBoundaries() {
      const table = document.getElementById('pool-table');
      const rect = table.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;
      const wallThickness = 20;
      
      const boundaries = [
        Matter.Bodies.rectangle(width/2, -wallThickness/2, width, wallThickness, { isStatic: true }),
        Matter.Bodies.rectangle(width/2, height + wallThickness/2, width, wallThickness, { isStatic: true }),
        Matter.Bodies.rectangle(-wallThickness/2, height/2, wallThickness, height, { isStatic: true }),
        Matter.Bodies.rectangle(width + wallThickness/2, height/2, wallThickness, height, { isStatic: true })
      ];
      
      Matter.World.add(gameState.world, boundaries);
    }

    // 创建台球
    function createBalls() {
      const table = document.getElementById('pool-table');
      const rect = table.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;
      const ballRadius = Math.min(width, height) * 0.025;
      
      // 创建母球
      gameState.cueBall = Matter.Bodies.circle(
        width * 0.75,
        height / 2,
        ballRadius,
        { restitution: 0.8, friction: 0.05, frictionAir: 0.001 }
      );
      
      gameState.balls = [gameState.cueBall];
      
      // 根据模式创建目标球
      if (gameState.selectedMode === 'eight-ball') {
        createEightBallBalls(width, height, ballRadius);
      } else if (gameState.selectedMode === 'nine-ball') {
        createNineBallBalls(width, height, ballRadius);
      } else {
        createSnookerBalls(width, height, ballRadius);
      }
      
      Matter.World.add(gameState.world, gameState.balls);
      renderBalls();
    }

    // 创建中式八球球组
    function createEightBallBalls(width, height, radius) {
      const colors = [
        '#FF0000', '#0000FF', '#FF8000', '#8000FF', '#FFFF00', 
        '#00FF00', '#FF00FF', '#000000', '#FF6666', '#6666FF',
        '#FFBB66', '#BB80FF', '#FFFF66', '#66FF66', '#FF66FF'
      ];
      
      const startX = width * 0.25;
      const startY = height / 2;
      const spacing = radius * 2.2;
      
      let ballIndex = 0;
      for (let row = 0; row < 5; row++) {
        const rowLength = 5 - row;
        const rowStartX = startX - (rowLength - 1) * spacing / 2;
        
        for (let col = 0; col < rowLength; col++) {
          if (ballIndex >= colors.length) break;
          
          const ball = Matter.Bodies.circle(
            rowStartX + col * spacing,
            startY + row * spacing * 0.866,
            radius,
            {
              restitution: 0.8, friction: 0.05, frictionAir: 0.001,
              color: colors[ballIndex], number: ballIndex + 1
            }
          );
          
          gameState.balls.push(ball);
          ballIndex++;
        }
      }
    }

    // 创建中式九球球组
    function createNineBallBalls(width, height, radius) {
      const colors = [
        '#FFFF00', '#0000FF', '#FF0000', '#8000FF', '#FF8000',
        '#00FF00', '#8B4513', '#000000', '#FFC0CB'
      ];
      
      const startX = width * 0.25;
      const startY = height / 2;
      const spacing = radius * 2.2;
      
      // 1号球
      const ball1 = Matter.Bodies.circle(startX, startY, radius, {
        restitution: 0.8, friction: 0.05, frictionAir: 0.001,
        color: colors[0], number: 1
      });
      gameState.balls.push(ball1);
      
      // 2-3号球
      const ball2 = Matter.Bodies.circle(startX - spacing/2, startY - spacing*0.866/2, radius, {
        restitution: 0.8, friction: 0.05, frictionAir: 0.001,
        color: colors[1], number: 2
      });
      
      const ball3 = Matter.Bodies.circle(startX + spacing/2, startY - spacing*0.866/2, radius, {
        restitution: 0.8, friction: 0.05, frictionAir: 0.001,
        color: colors[2], number: 3
      });
      
      gameState.balls.push(ball2, ball3);
      
      // 4-6号球
      const ball4 = Matter.Bodies.circle(startX - spacing, startY - spacing*0.866, radius, {
        restitution: 0.8, friction: 0.05, frictionAir: 0.001,
        color: colors[3], number: 4
      });
      
      const ball5 = Matter.Bodies.circle(startX, startY - spacing*0.866, radius, {
        restitution: 0.8, friction: 0.05, frictionAir: 0.001,
        color: colors[4], number: 5
      });
      
      const ball6 = Matter.Bodies.circle(startX + spacing, startY - spacing*0.866, radius, {
        restitution: 0.8, friction: 0.05, frictionAir: 0.001,
        color: colors[5], number: 6
      });
      
      gameState.balls.push(ball4, ball5, ball6);
      
      // 7-9号球
      const ball7 = Matter.Bodies.circle(startX - spacing/2, startY - spacing*0.866*1.5, radius, {
        restitution: 0.8, friction: 0.05, frictionAir: 0.001,
        color: colors[6], number: 7
      });
      
      const ball8 = Matter.Bodies.circle(startX + spacing/2, startY - spacing*0.866*1.5, radius, {
        restitution: 0.8, friction: 0.05, frictionAir: 0.001,
        color: colors[7], number: 8
      });
      
      const ball9 = Matter.Bodies.circle(startX, startY - spacing*0.866*2, radius, {
        restitution: 0.8, friction: 0.05, frictionAir: 0.001,
        color: colors[8], number: 9
      });
      
      gameState.balls.push(ball7, ball8, ball9);
    }

    // 创建斯诺克球组
    function createSnookerBalls(width, height, radius) {
      // 红球
      for (let i = 0; i < 15; i++) {
        const x = width * 0.25 + (i % 5) * radius * 2.2;
        const y = height / 2 + Math.floor(i / 5) * radius * 2.2;
        
        const ball = Matter.Bodies.circle(x, y, radius, {
          restitution: 0.8, friction: 0.05, frictionAir: 0.001,
          color: '#FF0000', type: 'red', points: 1
        });
        
        gameState.balls.push(ball);
      }
      
      // 彩球
      const colors = ['#FFFF00', '#00FF00', '#8B4513', '#0000FF', '#FFC0CB', '#000000'];
      const positions = [
        {x: width*0.25, y: height/2 - radius*6},
        {x: width*0.25, y: height/2 - radius*3},
        {x: width*0.25, y: height/2},
        {x: width*0.25, y: height/2 + radius*3},
        {x: width*0.25, y: height/2 + radius*6},
        {x: width*0.125, y: height/2}
      ];
      
      for (let i = 0; i < colors.length; i++) {
        const ball = Matter.Bodies.circle(
          positions[i].x, positions[i].y, radius,
          {
            restitution: 0.8, friction: 0.05, frictionAir: 0.001,
            color: colors[i], type: 'colored', points: i + 2
          }
        );
        gameState.balls.push(ball);
      }
    }

    // 渲染台球
    function renderBalls() {
      const table = document.getElementById('pool-table');
      document.querySelectorAll('.pool-ball').forEach(ball => ball.remove());
      
      gameState.balls.forEach((ball, index) => {
        const ballElement = document.createElement('div');
        ballElement.className = 'pool-ball';
        ballElement.style.width = ball.circleRadius * 2 + 'px';
        ballElement.style.height = ball.circleRadius * 2 + 'px';
        ballElement.style.left = ball.position.x - ball.circleRadius + 'px';
        ballElement.style.top = ball.position.y - ball.circleRadius + 'px';
        
        if (index === 0) {
          ballElement.id = 'cue-ball';
          ballElement.style.backgroundColor = '#FFFFFF';
        } else {
          ballElement.style.backgroundColor = ball.color || '#000000';
          if (ball.number) {
            ballElement.innerHTML = `<span style="font-size: ${ball.circleRadius * 0.6}px;">${ball.number}</span>`;
          }
        }
        
        table.appendChild(ballElement);
      });
      
      updateBallPositions();
    }

    // 检测球是否进袋
    function isBallInPocket(ball) {
      const table = document.getElementById('pool-table');
      const rect = table.getBoundingClientRect();
      const pocketRadius = 30;
      const pockets = [
        {x: 0, y: 0}, {x: rect.width, y: 0},
        {x: 0, y: rect.height}, {x: rect.width, y: rect.height},
        {x: rect.width/2, y: 0}, {x: rect.width/2, y: rect.height}
      ];
      
      for (const pocket of pockets) {
        const dx = ball.position.x - pocket.x;
        const dy = ball.position.y - pocket.y;
        const distance = Math.sqrt(dx*dx + dy*dy);
        if (distance < pocketRadius + ball.circleRadius) {
          return true;
        }
      }
      return false;
    }

    // 重置母球位置
    function resetCueBall() {
      const table = document.getElementById('pool-table');
      const rect = table.getBoundingClientRect();
      Matter.Body.setPosition(gameState.cueBall, {
        x: rect.width * 0.75,
        y: rect.height / 2
      });
      Matter.Body.setVelocity(gameState.cueBall, {x: 0, y: 0});
    }

    // 移除球
    function removeBall(index) {
      const ball = gameState.balls[index];
      Matter.World.remove(gameState.world, ball);
      gameState.balls.splice(index, 1);
      
      const ballElements = document.querySelectorAll('.pool-ball');
      if (ballElements[index]) {
        ballElements[index].remove();
      }
      
      playSound('pocket');
    }

    // 更新得分
    function updateScore(ball) {
      if (gameState.currentTurn === 'player') {
        if (gameState.selectedMode === 'eight-ball') {
          gameState.playerScore++;
        } else if (gameState.selectedMode === 'nine-ball') {
          if (ball.number === gameState.nextBall) {
            gameState.playerScore++;
            gameState.nextBall = ball.number + 1;
          }
        } else if (gameState.selectedMode === 'snooker') {
          gameState.playerScore += ball.points;
        }
        document.getElementById('player-score').textContent = gameState.playerScore;
      } else {
        if (gameState.selectedMode === 'eight-ball') {
          gameState.computerScore++;
        } else if (gameState.selectedMode === 'nine-ball') {
          if (ball.number === gameState.computerNextBall) {
            gameState.computerScore++;
            gameState.computerNextBall = ball.number + 1;
          }
        } else if (gameState.selectedMode === 'snooker') {
          gameState.computerScore += ball.points;
        }
        document.getElementById('computer-score').textContent = gameState.computerScore;
      }
      
      checkGameOver();
    }

    // 检查游戏是否结束
    function checkGameOver() {
      if (gameState.selectedMode === 'eight-ball') {
        const blackBall = gameState.balls.find(ball => ball.number === 8);
        if (!blackBall) endGame();
      } else if (gameState.selectedMode === 'nine-ball') {
        const nineBall = gameState.balls.find(ball => ball.number === 9);
        if (!nineBall) endGame();
      } else if (gameState.selectedMode === 'snooker') {
        const redBallsLeft = gameState.balls.filter(ball => ball.type === 'red').length;
        if (redBallsLeft === 0 && gameState.balls.length <= 7) endGame();
      }
    }

    // 结束游戏
    function endGame() {
      const title = document.getElementById('game-over-title');
      const message = document.getElementById('game-over-message');
      const playerScore = document.getElementById('final-player-score');
      const computerScore = document.getElementById('final-computer-score');
      
      playerScore.textContent = gameState.playerScore;
      computerScore.textContent = gameState.computerScore;
      
      if (gameState.playerScore > gameState.computerScore) {
        title.textContent = '恭喜！';
        message.textContent = '你赢了！';
      } else if (gameState.playerScore < gameState.computerScore) {
        title.textContent = '游戏结束';
        message.textContent = '你输了！';
      } else {
        title.textContent = '游戏结束';
        message.textContent = '平局！';
      }
      
      document.getElementById('game-over-modal').classList.add('active');
    }

    // 更新球位置
    function updateBallPositions() {
      if (!gameState.engine) return;
      
      const ballsToRemove = [];
      
      gameState.balls.forEach((ball, index) => {
        const ballElement = index === 0 
          ? document.getElementById('cue-ball') 
          : document.querySelectorAll('.pool-ball')[index];
          
        if (ballElement) {
          ballElement.style.left = ball.position.x - ball.circleRadius + 'px';
          ballElement.style.top = ball.position.y - ball.circleRadius + 'px';
          ballElement.style.transform = `rotate(${ball.angle * 180 / Math.PI}deg)`;
        }
        
        if (isBallInPocket(ball)) {
          ballsToRemove.push({index, ball});
        }
      });
      
      ballsToRemove.forEach(item => {
        const {index, ball} = item;
        if (index === 0) {
          resetCueBall();
        } else {
          removeBall(index);
          updateScore(ball);
        }
      });
      
      requestAnimationFrame(updateBallPositions);
    }

    // 绑定台球桌交互事件
    function bindTableEvents() {
      const table = document.getElementById('pool-table');
      
      table.addEventListener('mousedown', startDrag);
      table.addEventListener('touchstart', startDrag, {passive: false});
      
      document.addEventListener('mousemove', drag);
      document.addEventListener('touchmove', drag, {passive: false});
      
      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchend', endDrag);
    }

    // 开始拖拽（瞄准）
    function startDrag(e) {
      e.preventDefault();
      
      if (gameState.currentTurn !== 'player' || gameState.isPaused) return;
      
      const table = document.getElementById('pool-table');
      const rect = table.getBoundingClientRect();
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      
      const cueBall = gameState.cueBall;
      const dx = x - cueBall.position.x;
      const dy = y - cueBall.position.y;
      const distance = Math.sqrt(dx*dx + dy*dy);
      
      if (distance <= cueBall.circleRadius) {
        gameState.isDragging = true;
        gameState.dragStart = {x, y};
        document.getElementById('pool-cue').style.display = 'block';
        updateCuePosition(x, y);
      }
    }

    // 拖拽中（调整角度和力度）
    function drag(e) {
      if (!gameState.isDragging) return;
      
      const table = document.getElementById('pool-table');
      const rect = table.getBoundingClientRect();
      const clientX = e.clientX || e.touches[0].clientX;
      const clientY = e.clientY || e.touches[0].clientY;
      
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      
      updateCuePosition(x, y);
      
      const dx = x - gameState.dragStart.x;
      const dy = y - gameState.dragStart.y;
      const distance = Math.sqrt(dx*dx + dy*dy);
      
      gameState.power = Math.min(distance / 3, 100);
      
      document.getElementById('power-bar').style.width = gameState.power + '%';
      document.getElementById('power-value').textContent = Math.round(gameState.power) + '%';
      
      showPredictionLine(x, y);
    }

    // 结束拖拽（击球）
    function endDrag(e) {
      if (!gameState.isDragging) return;
      
      const table = document.getElementById('pool-table');
      const rect = table.getBoundingClientRect();
      const clientX = e.clientX || (e.changedTouches && e.changedTouches[0].clientX);
      const clientY = e.clientY || (e.changedTouches && e.changedTouches[0].clientY);
      
      if (clientX && clientY) {
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        shoot(x, y);
      }
      
      document.getElementById('pool-cue').style.display = 'none';
      document.getElementById('prediction-line').style.display = 'none';
      
      document.getElementById('power-bar').style.width = '0%';
      document.getElementById('power-value').textContent = '0%';
      
      gameState.isDragging = false;
    }

    // 更新球杆位置
    function updateCuePosition(x, y) {
      const cueBall = gameState.cueBall;
      const angle = Math.atan2(y - cueBall.position.y, x - cueBall.position.x);
      
      const dx = x - cueBall.position.x;
      const dy = y - cueBall.position.y;
      const distance = Math.sqrt(dx*dx + dy*dy);
      const cueLength = Math.min(distance, 150);
      
      const cue = document.getElementById('pool-cue');
      cue.style.width = cueLength + 'px';
      cue.style.left = cueBall.position.x + 'px';
      cue.style.top = cueBall.position.y + 'px';
      cue.style.transform = `rotate(${angle}rad)`;
    }

    // 显示预测线
    function showPredictionLine(x, y) {
      const cueBall = gameState.cueBall;
      const angle = Math.atan2(y - cueBall.position.y, x - cueBall.position.x);
      
      const lineLength = gameState.power * 2;
      
      const line = document.getElementById('prediction-line');
      line.style.display = 'block';
      line.style.width = lineLength + 'px';
      line.style.left = cueBall.position.x + 'px';
      line.style.top = cueBall.position.y + 'px';
      line.style.transform = `rotate(${angle}rad)`;
    }

    // 击球
    function shoot(x, y) {
      const cueBall = gameState.cueBall;
      const angle = Math.atan2(y - cueBall.position.y, x - cueBall.position.x);
      
      const dx = x - gameState.dragStart.x;
      const dy = y - gameState.dragStart.y;
      const distance = Math.sqrt(dx*dx + dy*dy);
      const force = Math.min(distance / 5, 20);
      
      Matter.Body.apply
